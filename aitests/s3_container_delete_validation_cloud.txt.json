{
  "description": "Validate that a cluster with s3Containers set to 2 can be provisioned, and deletion of an S3 container finishes within 10 minutes",
  "name": "s3_container_provisioning_and_deletion_test",
  "steps": [
    {
      "name": "generate_cluster_name",
      "requirements": "Generate a WekaCluster name with the prefix 'test-' ensuring it is no longer than 32 characters and conforms to Kubernetes resource naming conventions. The autogenerated part should not be longer than 16 characters.",
      "outputs": ["cluster_name"]
    },
    {
      "name": "generate_namespace_name",
      "requirements": "Create a namespace name with the prefix 'test-' followed by an autogenerated part.",
      "outputs": ["namespace_name"]
    },
    {
      "name": "create_namespace",
      "requirements": "Create a Kubernetes namespace with the name $generate_namespace_name__namespace_name",
      "inputs": ["generate_namespace_name.namespace_name"],
      "outputs": ["namespace_created"]
    },
    {
      "name": "create_wekacluster_yaml",
      "requirements": "Create a WekaCluster YAML with the following specifications:\n- apiVersion: weka.weka.io/v1alpha1\n- kind: WekaCluster\n- name: $generate_cluster_name__cluster_name\n- namespace: $generate_namespace_name__namespace_name\n- template: dynamic\n- dynamicTemplate.computeContainers: 6\n- dynamicTemplate.driveContainers: 6\n- dynamicTemplate.numDrives: 1\n- dynamicTemplate.s3Containers: 2\n- hotSpare: 1\n- basePort: 35500\n- startIoConditions.minNumDrives: 5\n- overrides: {}\n- image: quay.io/weka.io/weka-in-container:4.4.2.157-k8s\n- nodeSelector: weka.io/supports-backends=\"true\"\nDo not specify hugepages, cores (compute, drive) in dynamicTemplate, redundancyLevel, bucketRaftSize, or leadershipRaftSize.",
      "inputs": ["generate_cluster_name.cluster_name", "generate_namespace_name.namespace_name"],
      "outputs": ["wekacluster_yaml"]
    },
    {
      "name": "apply_wekacluster",
      "requirements": "Apply the WekaCluster YAML to the Kubernetes cluster using python script execution to avoid whitespace issues. Use the YAML content from $create_wekacluster_yaml__wekacluster_yaml in namespace $generate_namespace_name__namespace_name.",
      "inputs": ["create_wekacluster_yaml.wekacluster_yaml", "generate_namespace_name.namespace_name"],
      "outputs": ["wekacluster_applied"]
    },
    {
      "name": "wait_for_cluster_ready",
      "requirements": "Poll the Kubernetes API against the WekaCluster object and check status.status field. Wait until it reaches 'Ready' status or timeout after 10 minutes. The cluster name is $generate_cluster_name__cluster_name in namespace $generate_namespace_name__namespace_name.",
      "inputs": ["generate_cluster_name.cluster_name", "generate_namespace_name.namespace_name"],
      "outputs": ["cluster_ready", "timeout_occurred"]
    },
    {
      "name": "extract_cluster_uid",
      "requirements": "Extract the WekaCluster metadata.uid (cluster ID) for the cluster named $generate_cluster_name__cluster_name in namespace $generate_namespace_name__namespace_name. This UID will be used for filtering Weka containers by cluster.",
      "inputs": ["generate_cluster_name.cluster_name", "generate_namespace_name.namespace_name", "wait_for_cluster_ready.cluster_ready"],
      "outputs": ["cluster_uid"]
    },
    {
      "name": "get_drive_container",
      "requirements": "Find a drive container (WekaContainer) from the cluster with cluster ID $extract_cluster_uid__cluster_uid in namespace $generate_namespace_name__namespace_name using the label selector 'weka.io/cluster-id=$extract_cluster_uid__cluster_uid,weka.io/mode=drive'. Retrieve both the container name and spec.name.",
      "inputs": ["extract_cluster_uid.cluster_uid", "generate_namespace_name.namespace_name"],
      "outputs": ["drive_container_name", "drive_container_spec_name"]
    },
    {
      "name": "get_drive_container_pod",
      "requirements": "Find the pod name associated with the drive container named $get_drive_container__drive_container_name in namespace $generate_namespace_name__namespace_name. This pod will be used to execute Weka commands.",
      "inputs": ["get_drive_container.drive_container_name", "generate_namespace_name.namespace_name"],
      "outputs": ["drive_pod_name"]
    },
    {
      "name": "check_s3_status",
      "requirements": "Execute 'weka s3 cluster status' command in the drive pod named $get_drive_container_pod__drive_pod_name in namespace $generate_namespace_name__namespace_name. Verify that there are exactly 2 S3 containers listed and that all of them have a status of 'Online'. Wait up to 3 minutes for the S3 containers to become operational. The command should be run as: kubectl exec -n $generate_namespace_name__namespace_name $get_drive_container_pod__drive_pod_name -- weka s3 cluster status",
      "inputs": ["get_drive_container_pod.drive_pod_name", "generate_namespace_name.namespace_name"],
      "outputs": ["s3_containers_online", "s3_status_output"]
    },
    {
      "name": "get_s3_containers",
      "requirements": "Get a list of S3 containers (WekaContainers) from the cluster with cluster ID $extract_cluster_uid__cluster_uid in namespace $generate_namespace_name__namespace_name using the label selector 'weka.io/cluster-id=$extract_cluster_uid__cluster_uid,weka.io/mode=s3'. Verify there are exactly 2 S3 containers as specified in the WekaCluster configuration.",
      "inputs": ["extract_cluster_uid.cluster_uid", "generate_namespace_name.namespace_name"],
      "outputs": ["s3_container_names"]
    },
    {
      "name": "select_s3_container_to_delete",
      "requirements": "Select one S3 container from the list of S3 containers $get_s3_containers__s3_container_names to delete. Any container can be selected.",
      "inputs": ["get_s3_containers.s3_container_names"],
      "outputs": ["s3_container_to_delete"]
    },
    {
      "name": "delete_s3_container",
      "requirements": "Delete the selected S3 container named $select_s3_container_to_delete__s3_container_to_delete in namespace $generate_namespace_name__namespace_name using 'kubectl delete wekacontainer <s3-container-name> -n <namespace> --wait=false'. The --wait=false flag ensures non-blocking deletion.",
      "inputs": ["select_s3_container_to_delete.s3_container_to_delete", "generate_namespace_name.namespace_name"],
      "outputs": ["deletion_initiated"]
    },
    {
      "name": "wait_for_s3_container_deletion",
      "requirements": "Poll for the status/existence of the deleted S3 container named $select_s3_container_to_delete__s3_container_to_delete in namespace $generate_namespace_name__namespace_name. Wait up to 5 minutes for deletion to complete. The container is considered deleted when it no longer exists in the namespace.",
      "inputs": ["select_s3_container_to_delete.s3_container_to_delete", "generate_namespace_name.namespace_name"],
      "outputs": ["container_deleted", "deletion_timeout"]
    },
    {
      "name": "wait_for_replacement_s3_container",
      "requirements": "Check for a replacement S3 container using the label selector 'weka.io/cluster-id=$extract_cluster_uid__cluster_uid,weka.io/mode=s3' in namespace $generate_namespace_name__namespace_name. A replacement is confirmed when the count of S3 containers equals 2 (the original count) and there is a new container not in the original list $get_s3_containers__s3_container_names. Wait up to 5 minutes for the replacement container to appear.",
      "inputs": ["get_s3_containers.s3_container_names", "select_s3_container_to_delete.s3_container_to_delete", "extract_cluster_uid.cluster_uid", "generate_namespace_name.namespace_name", "wait_for_s3_container_deletion.container_deleted"],
      "outputs": ["replacement_container_created", "new_s3_container_names"]
    },
    {
      "name": "identify_new_s3_container",
      "requirements": "Identify the new S3 container by finding which container name in $wait_for_replacement_s3_container__new_s3_container_names is not in the original list $get_s3_containers__s3_container_names. This will be the replacement container that was created after deletion.",
      "inputs": ["wait_for_replacement_s3_container.new_s3_container_names", "get_s3_containers.s3_container_names"],
      "outputs": ["new_s3_container_name"]
    },
    {
      "name": "check_new_s3_container_status",
      "requirements": "Execute 'weka s3 cluster status' command in the drive pod named $get_drive_container_pod__drive_pod_name in namespace $generate_namespace_name__namespace_name. Verify that there are exactly 2 S3 containers listed and that all have a status of 'Online'. Wait up to 5 minutes for the new S3 container to become operational. The command should be run as: kubectl exec -n $generate_namespace_name__namespace_name $get_drive_container_pod__drive_pod_name -- weka s3 cluster status",
      "inputs": ["get_drive_container_pod.drive_pod_name", "generate_namespace_name.namespace_name", "identify_new_s3_container.new_s3_container_name"],
      "outputs": ["new_s3_container_online"]
    }
  ],
  "documentation": "# Test Plan for Weka Cluster with S3 Containers\n\n## Test Goal\nValidate that a cluster with `s3Containers` set to 2 can be provisioned, and the deletion of an S3 container finishes within 10 minutes.\n\n## Environment Requirements\n- Kubernetes cluster on AWS cloud environment\n- Nodes with label `weka.io/supports-backends=\"true\"`\n- Access to the Weka container image `quay.io/weka.io/weka-in-container:4.4.2.157-k8s`\n\n## Test Steps Overview\n1. Generate unique cluster and namespace names\n2. Create a namespace for test resources\n3. Create a WekaCluster CR with required specifications\n4. Wait for the cluster to reach Ready status\n5. Extract the cluster UID for resource filtering\n6. Verify S3 container status is \"Online\"\n7. Delete one S3 container and monitor deletion process\n8. Validate that a replacement S3 container is created\n9. Verify the new S3 container becomes operational\n\n## Important Notes\n- The test will create resources with autogenerated names prefixed with \"test-\"\n- Do not delete the WekaCluster after test execution\n- No Kubernetes resources should be deleted as part of this testing (except the single S3 container for testing)\n- Container filtering should always use the cluster-id label\n- S3 container status is checked using the Weka CLI command \"weka s3 cluster status\"\n- Container deletion should be non-blocking using \"--wait=false\"\n- Maximum wait time for deletion is 5 minutes\n- Maximum wait time for cluster provisioning is 10 minutes\n- Maximum wait time for new S3 container to become operational is 5 minutes\n\n## Command Reference\n- To filter Weka containers:\n  `kubectl get -n <namespace> wekacontainer -l weka.io/cluster-id=<cluster-id>,weka.io/mode=<mode>`\n- To execute Weka commands in a container:\n  `kubectl exec -n <namespace> <pod-name> -- weka <command>`\n- To check S3 status:\n  `weka s3 cluster status`\n- To delete a container:\n  `kubectl delete wekacontainer <container-name> -n <namespace> --wait=false`\n\n## Example WekaCluster YAML\n```yaml\napiVersion: weka.weka.io/v1alpha1\nkind: WekaCluster\nmetadata:\n  name: test-autogenerated-name\n  namespace: test-autogenerated-namespace\nspec:\n  template: dynamic\n  dynamicTemplate:\n    computeContainers: 6\n    driveContainers: 6\n    numDrives: 1\n    s3Containers: 2\n  hotSpare: 1\n  basePort: 35500\n  startIoConditions:\n    minNumDrives: 5\n  overrides: {}\n  image: quay.io/weka.io/weka-in-container:4.4.2.157-k8s\n  nodeSelector:\n    weka.io/supports-backends: \"true\"\n```\n\n## Finding Leadership Processes\nTo find leadership processes and the container name:\n```\nweka cluster processes -o id,container -l\n```\n\nTo find a leader (one amongst leadership):\n```\nweka cluster processes -o id,container -L\n```\n\n## Container Name Correlation\n- Container name from within Weka can be correlated to k8s name container by wekacontainer.spec.name.\n- Example command to find all Weka containers in a namespace that belong to a specific cluster:\n  ```\n  kubectl get -n <namespace> wekacontainer -o custom-columns=NAME:.metadata.name,SPEC_NAME:.spec.name -l weka.io/cluster-id=<cluster-id>,weka.io/mode=<mode>\n  ```"
}