{
  "description": "Validate that a cluster with s3Containers set to 2 can be provisioned, expanded to 5 s3Containers and then removed in a physical environment.",
  "name": "provision_expand_remove_s3_containers_test",
  "steps": [
    {
      "name": "create_namespace",
      "requirements": "Create a Kubernetes namespace with a test-prefixed autogenerated name. Use command: `kubectl create namespace test-<autogenerated-name>` where <autogenerated-name> is a unique string of alphanumeric characters.",
      "outputs": ["namespace"]
    },
    {
      "name": "generate_cluster_name",
      "requirements": "Generate a unique cluster name with format 'test-<autogenerated-name>' where <autogenerated-name> is a unique string. The name should conform to Kubernetes naming conventions (lowercase, alphanumeric, and hyphens).",
      "outputs": ["cluster_name"]
    },
    {
      "name": "create_wekacluster_yaml",
      "requirements": "Create WekaCluster CR YAML with the following specifications in namespace $create_namespace__namespace and name $generate_cluster_name__cluster_name:\n- apiVersion: weka.weka.io/v1alpha1\n- 8 compute containers with 2 cores each and 10000 hugepages\n- 8 drive containers with 2 cores each\n- 2 drives per container\n- 2 s3Containers initially\n- Hot spare of 1\n- Leadership raft size of 5\n- Bucket raft size of 5\n- Redundancy level of 2\n- GracefulDestroyDuration of 0s\n- MinNumDrives startIO condition of 14\n- NodeSelector with weka.io/dedicated=anton\n- DeviceSubnets with 10.200.0.0/16\n- Image quay.io/weka.io/weka-in-container:4.4.2.157-k8s.2\n- Appropriate imagePullSecret and driversDistService\n- Include network section as the cluster is deployed on a physical environment",
      "inputs": ["create_namespace.namespace", "generate_cluster_name.cluster_name"],
      "outputs": ["wekacluster_yaml"]
    },
    {
      "name": "apply_wekacluster",
      "requirements": "Apply the WekaCluster CR YAML $create_wekacluster_yaml__wekacluster_yaml in namespace $create_namespace__namespace using kubectl apply -f - with the content piped to stdin. Use python script execution to apply yaml to avoid whitespace issues.",
      "inputs": ["create_namespace.namespace", "create_wekacluster_yaml.wekacluster_yaml"],
      "outputs": ["apply_result"]
    },
    {
      "name": "extract_cluster_uid",
      "requirements": "Extract the metadata.uid of the created WekaCluster resource $generate_cluster_name__cluster_name in namespace $create_namespace__namespace using the command: `kubectl get wekacluster $generate_cluster_name__cluster_name -n $create_namespace__namespace -o jsonpath={.metadata.uid}`",
      "inputs": ["create_namespace.namespace", "generate_cluster_name.cluster_name"],
      "outputs": ["cluster_uid"]
    },
    {
      "name": "wait_for_cluster_ready",
      "requirements": "Monitor the WekaCluster $generate_cluster_name__cluster_name in namespace $create_namespace__namespace until it reaches 'Ready' state (timeout: 10 minutes). Use command: `kubectl get wekacluster $generate_cluster_name__cluster_name -n $create_namespace__namespace -o jsonpath={.status.status}` and check for 'Ready' value.",
      "inputs": ["create_namespace.namespace", "generate_cluster_name.cluster_name"],
      "outputs": ["ready_status"]
    },
    {
      "name": "expand_s3_containers",
      "requirements": "Patch the WekaCluster $generate_cluster_name__cluster_name in namespace $create_namespace__namespace to increase s3Containers from 2 to 5 using the command: `kubectl patch wekacluster $generate_cluster_name__cluster_name -n $create_namespace__namespace --type=merge -p '{\"spec\":{\"dynamicTemplate\":{\"s3Containers\": 5}}}'`",
      "inputs": ["create_namespace.namespace", "generate_cluster_name.cluster_name"],
      "outputs": ["expand_result"]
    },
    {
      "name": "get_s3_container_pod",
      "requirements": "Find an S3 container pod with labels weka.io/cluster-id=$extract_cluster_uid__cluster_uid and weka.io/mode=s3 in namespace $create_namespace__namespace using command: `kubectl get pods -n $create_namespace__namespace -l weka.io/cluster-id=$extract_cluster_uid__cluster_uid,weka.io/mode=s3 -o name`. NEVER select wekacontainer or pod without filtering by specific cluster-id.",
      "inputs": ["create_namespace.namespace", "extract_cluster_uid.cluster_uid"],
      "outputs": ["s3_pod_name"]
    },
    {
      "name": "validate_s3_containers",
      "requirements": "Execute 'weka s3 cluster status' command in the S3 pod $get_s3_container_pod__s3_pod_name in namespace $create_namespace__namespace using the command: `kubectl exec -it $get_s3_container_pod__s3_pod_name -n $create_namespace__namespace -- weka s3 cluster status`. Verify that all 5 S3 containers are operational. It might take up to 3 minutes for them to become operational. Statuses such as OK, REDISTRIBUTING, PARTIALLY_PROTECTED, REBUILDING considered healthy.",
      "inputs": ["create_namespace.namespace", "get_s3_container_pod.s3_pod_name"],
      "outputs": ["validation_result"]
    },
    {
      "name": "delete_wekacluster",
      "requirements": "Delete the WekaCluster $generate_cluster_name__cluster_name in namespace $create_namespace__namespace using the command: `kubectl delete wekacluster $generate_cluster_name__cluster_name -n $create_namespace__namespace`",
      "inputs": ["create_namespace.namespace", "generate_cluster_name.cluster_name"],
      "outputs": ["delete_initiated"]
    },
    {
      "name": "verify_deletion",
      "requirements": "Monitor the Kubernetes API to ensure the WekaCluster resource $generate_cluster_name__cluster_name in namespace $create_namespace__namespace is fully deleted (timeout: 10 minutes). Use command: `kubectl get wekacluster $generate_cluster_name__cluster_name -n $create_namespace__namespace` and confirm it eventually returns a 'not found' error.",
      "inputs": ["create_namespace.namespace", "generate_cluster_name.cluster_name"],
      "outputs": ["deletion_verified"]
    }
  ],
  "documentation": "## Test Scenario\n\nThis test validates that a WekaCluster with s3Containers set to 2 can be provisioned, expanded to 5 s3Containers, and then removed in a physical environment.\n\n## Environment Setup\n\n- This test runs on a physical environment\n- Use 10.200.0.0/16 subnet for testing\n- All objects should use nodeSelector weka.io/dedicated=anton\n\n## Important Notes\n\n- Do not delete WekaCluster after test execution regardless of results, unless asked explicitly\n- Do not delete any Kubernetes resources as part of testing\n- Use weka.io/mode=compute|drive,weka.io/cluster-id=<cluster-id> to filter compute and drive containers\n- Cluster id references kubernetes metadata.uid\n- WekaCluster CR should use:\n  - apiVersion: weka.weka.io/v1alpha1\n  - 8 compute containers with 2 cores each and 10000 hugepages\n  - 8 drive containers with 2 cores each\n  - 2 drives per container\n  - Initially 2 s3Containers (later expanded to 5)\n  - Hot spare of 1\n  - Leadership raft size of 5\n  - Bucket raft size of 5\n  - Redundancy level of 2\n  - GracefulDestroyDuration of 0s (default is 24h)\n  - MinNumDrives startIO condition of 14\n  - NodeSelector with weka.io/dedicated=anton\n  - DeviceSubnets with 10.200.0.0/16\n  - Image quay.io/weka.io/weka-in-container:4.4.2.157-k8s.2\n  - Include network section as required for physical environment\n\n## Yaml Example\n```yaml\napiVersion: weka.weka.io/v1alpha1\nkind: WekaCluster\nmetadata:\n  name: <cluster_name>\n  namespace: <namespace>\nspec:\n  template: dynamic\n  dynamicTemplate:\n    computeContainers: 8\n    driveContainers: 8\n    computeCores: 2\n    driveCores: 2\n    computeHugepages: 10000\n    numDrives: 2\n    s3Containers: 2\n  hotSpare: 1\n  leadershipRaftSize: 5\n  bucketRaftSize: 5\n  redundancyLevel: 2\n  gracefulDestroyDuration: 0s\n  startIoConditions:\n    minNumDrives: 14\n  overrides: {}\n  image: quay.io/weka.io/weka-in-container:4.4.2.157-k8s.2\n  nodeSelector:\n    weka.io/dedicated: \"anton\"\n  driversDistService: \"https://weka-drivers-dist.weka-operator-system.svc.cluster.local:60002\"\n  imagePullSecret: \"quay-io-robot-secret\"\n  network:\n    deviceSubnets:\n      - 10.200.0.0/16\n```\n\n## Test Execution Flow\n\n1. Create a unique namespace with test- prefix\n2. Generate a unique cluster name with test- prefix\n3. Create the WekaCluster CR YAML with specified parameters\n4. Apply the WekaCluster CR\n5. Extract the cluster UID for pod selection\n6. Wait for the cluster to reach Ready state (timeout: 10 minutes)\n7. Patch the WekaCluster to increase s3Containers from 2 to 5\n8. Get an S3 container pod for validating S3 status\n9. Execute 'weka s3 cluster status' to verify all 5 S3 containers are operational\n10. Delete the WekaCluster\n11. Verify the WekaCluster is completely deleted from Kubernetes (timeout: 10 minutes)\n\n## S3 Container Validation\n\nWhen validating S3 containers, the following statuses indicate normal operation:\n- OK: The container is fully operational\n- REDISTRIBUTING: The container is operational but redistributing data\n- PARTIALLY_PROTECTED: The container is operational but not fully protected\n- REBUILDING: The container is operational but rebuilding data\n\nThis test should wait up to 3 minutes after expanding for all S3 containers to become operational."
}