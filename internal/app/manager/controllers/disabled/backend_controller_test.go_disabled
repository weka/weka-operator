package disabled

import (
	wekav1alpha1 "github.com/weka/weka-operator/internal/pkg/api/disabled"
	"time"

	. "github.com/onsi/ginkgo/v2"
	. "github.com/onsi/gomega"
	v1 "k8s.io/api/core/v1"
	apierrors "k8s.io/apimachinery/pkg/api/errors"
	"k8s.io/apimachinery/pkg/api/resource"
	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
	"k8s.io/apimachinery/pkg/types"
)

var _ = Describe("Integration Test", func() {
	var backend *wekav1alpha1.Backend
	var node *v1.Node
	const driveCount = 3

	BeforeEach(func() {
		node = &v1.Node{
			ObjectMeta: metav1.ObjectMeta{
				Name:      "test-node",
				Namespace: "default",
				Labels: map[string]string{
					"weka.io/role": "unspecified",
				},
			},
			Status: v1.NodeStatus{
				Allocatable: v1.ResourceList{
					"drive.weka.io/drive": *resource.NewQuantity(driveCount, resource.DecimalSI),
				},
			},
		}
		Expect(k8sClient.Create(TestCtx, node)).Should(BeNil())
		Eventually(func() error {
			return k8sClient.Get(TestCtx, types.NamespacedName{Name: "test-node", Namespace: "default"}, node)
		}).Should(BeNil())

		backend = &wekav1alpha1.Backend{
			ObjectMeta: metav1.ObjectMeta{
				Name:      "test-backend",
				Namespace: "default",
			},
			Spec: wekav1alpha1.BackendSpec{
				NodeName: "test-node",
			},
		}
		Expect(k8sClient.Create(TestCtx, backend)).Should(BeNil())
		Eventually(func() error {
			return k8sClient.Get(TestCtx, types.NamespacedName{Name: "test-backend", Namespace: "default"}, backend)
		}).Should(BeNil())
	})

	AfterEach(func() {
		k8sClient.Delete(TestCtx, backend)
		Eventually(func() bool {
			dummy := &wekav1alpha1.Backend{}
			err := k8sClient.Get(TestCtx, types.NamespacedName{Name: "test-backend", Namespace: "default"}, dummy)
			return apierrors.IsNotFound(err)
		})

		k8sClient.Delete(TestCtx, node)
		Eventually(func() bool {
			dummy := &v1.Node{}
			err := k8sClient.Get(TestCtx, types.NamespacedName{Name: "test-node", Namespace: "default"}, dummy)
			return apierrors.IsNotFound(err)
		})
	})

	It("should set drive count", func() {
		actual := &wekav1alpha1.Backend{}
		Eventually(func() int {
			key := types.NamespacedName{Name: "test-backend", Namespace: "default"}
			if err := k8sClient.Get(TestCtx, key, actual); err != nil {
				return -1
			}
			return actual.Status.DriveCount
		}).Should(Equal(driveCount))
	})

	It("should label node", func() {
		Eventually(func() string {
			updated := &v1.Node{}
			key := types.NamespacedName{Name: "test-node", Namespace: "default"}
			if err := k8sClient.Get(TestCtx, key, updated); err != nil {
				return ""
			}
			return updated.Labels["weka.io/backend"]
		}, time.Second*10, time.Millisecond*500).Should(Equal("test-backend"))
	})
})

var _ = Describe("BackendReconciler", func() {
	var r *BackendReconciler
	var node *v1.Node
	backend := &wekav1alpha1.Backend{
		ObjectMeta: metav1.ObjectMeta{
			Name: "test-backend",
		},
	}

	BeforeEach(func() {
		r = NewBackendReconciler(k8sManager)
		node = &v1.Node{
			ObjectMeta: metav1.ObjectMeta{
				Name:      "test-node",
				Namespace: "default",
				Labels: map[string]string{
					"weka.io/role": "unspecifiec",
				},
			},
		}
		Expect(k8sClient.Create(TestCtx, node)).Should(BeNil())
		Eventually(func() error {
			return k8sClient.Get(TestCtx, types.NamespacedName{Name: "test-node", Namespace: "default"}, node)
		}).Should(BeNil())
	})

	AfterEach(func() {
		k8sClient.Delete(TestCtx, node)
		Eventually(func() bool {
			dummy := &v1.Node{}
			err := k8sClient.Get(TestCtx, types.NamespacedName{Name: "test-node", Namespace: "default"}, dummy)
			return apierrors.IsNotFound(err)
		}).Should(BeTrue())
	})

	_ = Describe("labelNode", func() {
		It("should return nil", func() {
			Expect(r.labelNode(TestCtx, node, backend)).Should(BeNil())
		})

		It("should update the node", func() {
			Expect(r.labelNode(TestCtx, node, backend)).Should(BeNil())
			actual := &v1.Node{}
			Eventually(func() error {
				return k8sClient.Get(TestCtx, types.NamespacedName{Name: "test-node", Namespace: "default"}, actual)
			}).Should(BeNil())

			Expect(actual.Labels["weka.io/backend"]).Should(Equal("test-backend"))
		})
	})
})
