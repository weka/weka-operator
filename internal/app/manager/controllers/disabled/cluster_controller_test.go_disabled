package disabled

import (
	"github.com/weka/weka-operator/internal/app/manager/controllers"
	"github.com/weka/weka-operator/internal/pkg/api/disabled"
	"time"

	. "github.com/onsi/ginkgo/v2"
	. "github.com/onsi/gomega"
	v1 "k8s.io/api/core/v1"
	apierrors "k8s.io/apimachinery/pkg/api/errors"
	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
	"k8s.io/apimachinery/pkg/types"
	ctrl "sigs.k8s.io/controller-runtime"
)

var _ = Describe("Reconcile", func() {
	var cluster *disabled.Cluster
	var node *v1.Node
	BeforeEach(func() {
		node = &v1.Node{
			ObjectMeta: metav1.ObjectMeta{
				Name:      "test-node",
				Namespace: "default",
				Labels: map[string]string{
					"weka.io/role": "backend",
				},
			},
		}
		Expect(controllers.k8sClient.Create(TestCtx, node)).Should(BeNil())
		Eventually(func() error {
			return controllers.k8sClient.Get(TestCtx, types.NamespacedName{Name: "test-node", Namespace: "default"}, node)
		}).Should(BeNil())
		Expect(node.Name).Should(Equal("test-node"))
		Expect(node.Labels["weka.io/role"]).Should(Equal("backend"))

		cluster = &disabled.Cluster{
			ObjectMeta: metav1.ObjectMeta{
				Name:      "test-cluster",
				Namespace: "default",
			},
			Spec: disabled.ClusterSpec{
				SizeClass: "dev",
			},
		}
		Expect(controllers.k8sClient.Create(TestCtx, cluster)).Should(BeNil())
		Eventually(func() int {
			err := controllers.k8sClient.Get(TestCtx, types.NamespacedName{Name: "test-cluster", Namespace: "default"}, cluster)
			if err != nil {
				return -1
			}
			return len(cluster.Status.Nodes)
		}).Should(BeNumerically(">", 0))
	})

	AfterEach(func() {
		backends := &disabled.BackendList{}
		Expect(controllers.k8sClient.List(TestCtx, backends)).Should(BeNil())
		for _, backend := range backends.Items {
			controllers.k8sClient.Delete(TestCtx, &backend)
			Eventually(func() bool {
				dummy := &disabled.Backend{}
				err := controllers.k8sClient.Get(TestCtx, types.NamespacedName{Name: backend.Name, Namespace: backend.Namespace}, dummy)
				return apierrors.IsNotFound(err)
			})
		}

		controllers.k8sClient.Delete(TestCtx, cluster)
		Eventually(func() bool {
			dummy := &disabled.Cluster{}
			err := controllers.k8sClient.Get(TestCtx, types.NamespacedName{Name: "test-cluster", Namespace: "default"}, dummy)
			return apierrors.IsNotFound(err)
		})

		controllers.k8sClient.Delete(TestCtx, node)
		Eventually(func() bool {
			dummy := &v1.Node{}
			err := controllers.k8sClient.Get(TestCtx, types.NamespacedName{Name: "test-node", Namespace: "default"}, dummy)
			return apierrors.IsNotFound(err)
		})
	})

	It("should create a cluster", func() {
		Expect(cluster.Spec.SizeClass).Should(Equal("dev"))
	})

	It("should create one backend", func() {
		allBackends := &disabled.BackendList{}

		Eventually(func() error {
			err := controllers.k8sClient.List(TestCtx, allBackends)
			return err
		}, time.Second*10, time.Millisecond*500).Should(BeNil())
		Expect(len(allBackends.Items)).Should(Equal(1))

		actual := &disabled.Backend{}
		deployKey := types.NamespacedName{Name: "test-node", Namespace: "default"}
		Eventually(func() error {
			err := controllers.k8sClient.Get(TestCtx, deployKey, actual)
			return err
		}, time.Second*10, time.Millisecond*500).Should(BeNil())

		Expect(actual.Name).Should(Equal("test-node"))
	})
})

var _ = Describe("iteration", func() {
	var cluster *disabled.Cluster
	var iteration *iteration

	BeforeEach(func() {
		cluster = &disabled.Cluster{
			ObjectMeta: metav1.ObjectMeta{
				Name:      "test-cluster",
				Namespace: "default",
			},
			Spec: disabled.ClusterSpec{
				SizeClass: "dev",
			},
		}
		Expect(controllers.k8sClient.Create(TestCtx, cluster)).Should(BeNil())
		Eventually(func() error {
			return controllers.k8sClient.Get(TestCtx, types.NamespacedName{Name: "test-cluster", Namespace: "default"}, cluster)
		}).Should(BeNil())

		req := ctrl.Request{NamespacedName: types.NamespacedName{Name: "test-cluster", Namespace: "default"}}
		iteration = newIteration(req)
		iteration.cluster = cluster
	})

	AfterEach(func() {
		controllers.k8sClient.Delete(TestCtx, cluster)
		Eventually(func() bool {
			dummy := &disabled.Cluster{}
			err := controllers.k8sClient.Get(TestCtx, types.NamespacedName{Name: "test-cluster", Namespace: "default"}, dummy)
			return apierrors.IsNotFound(err)
		})
	})

	Describe("refreshNodes", func() {
		nodes := &v1.NodeList{}

		listNodes := func(list *v1.NodeList) error {
			list.Items = make([]v1.Node, 1)
			list.Items[0] = v1.Node{
				ObjectMeta: metav1.ObjectMeta{
					Name: "test-node",
					Labels: map[string]string{
						"weka.io/role": "backend",
					},
				},
			}
			return nil
		}

		var backendNodes []v1.Node
		BeforeEach(func() {
			node := &v1.Node{
				ObjectMeta: metav1.ObjectMeta{
					Name: "test-node",
					Labels: map[string]string{
						"weka.io/role": "backend",
					},
				},
			}
			Expect(controllers.k8sClient.Create(TestCtx, node)).Should(BeNil())
			Eventually(func() error {
				return controllers.k8sClient.Get(TestCtx, types.NamespacedName{Name: "test-node", Namespace: "default"}, node)
			}).Should(BeNil())
			nodes.Items = append(nodes.Items, *node)

			var err error
			backendNodes, err = iteration.refreshNodes(listNodes)
			Expect(err).Should(BeNil())
		})

		AfterEach(func() {
			for _, node := range nodes.Items {
				controllers.k8sClient.Delete(TestCtx, &node)
				Eventually(func() bool {
					dummy := &v1.Node{}
					err := controllers.k8sClient.Get(TestCtx, types.NamespacedName{Name: "test-node", Namespace: "default"}, dummy)
					return apierrors.IsNotFound(err)
				})
			}
		})

		It("populate backends", func() {
			Expect(len(backendNodes)).Should(Equal(1))
			Expect(backendNodes[0].Name).Should(Equal("test-node"))
		})
	})
})
