#!/usr/bin/env bash
set -euo pipefail

# supressing ugly logs/unsetting OTEL
unset OTEL_EXPORTER_OTLP_ENDPOINT ANTHROPIC_API_KEY
export DAGGER_NO_NAG=1

# Use DAGGER_RUNNER_POD environment variable if set, otherwise fail with helpful message
if [[ -z "${DAGGER_RUNNER_POD:-}" ]]; then
    echo "Error: DAGGER_RUNNER_POD environment variable is not set."
    echo "This script requires a remote Dagger runner. Set DAGGER_RUNNER_POD to the pod name."
    echo "Example: export DAGGER_RUNNER_POD='dagger-engine-pod-name'"
    exit 1
fi

export _EXPERIMENTAL_DAGGER_RUNNER_HOST="kube-pod://${DAGGER_RUNNER_POD}?namespace=${DAGGER_RUNNER_NAMESPACE:-infra}"

# Build additional args from environment variables
additional_args=()

# Add --operator-repo if DAGGER_OPERATOR_REPO is set
if [[ -n "${DAGGER_OPERATOR_REPO:-}" ]]; then
    additional_args+=("--operator-repo=${DAGGER_OPERATOR_REPO}")
fi

# Add --helm-repo if DAGGER_HELM_REPO is set
if [[ -n "${DAGGER_HELM_REPO:-}" ]]; then
    additional_args+=("--helm-repo=${DAGGER_HELM_REPO}")
fi

exec dagger "$@" "${additional_args[@]}"

