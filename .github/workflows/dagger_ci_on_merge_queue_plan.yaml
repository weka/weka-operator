name: dagger_ci_on_merge_queue_plan
on:
  pull_request:
    types: [opened, synchronize, labeled, reopened]

# make sure only one workflow is running at a time
concurrency:
  group: upgrade-test
  cancel-in-progress: false

env:
  INITIAL_WEKA_VERSION: "quay.io/weka.io/weka-in-container:4.4.5.95-k8s-safe-stop-and-metrics-alpha"
  NEW_WEKA_VERSION: "quay.io/weka.io/weka-in-container:4.4.5.118-k8s.3"

jobs:
  optimize_ci:
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.check_skip.outputs.skip }}
    steps:
    - name: Optimize CI
      id: check_skip
      uses: withgraphite/graphite-ci-action@main
      with:
        graphite_token: ${{ secrets.GRAPHITE_TOKEN }}

  run_condition_check:
    needs: optimize_ci
    if: |
      needs.optimize_ci.outputs.skip == 'false' &&
      (startsWith(github.head_ref, 'gtmq_') || 
      contains(github.event.pull_request.labels.*.name, 'run_ci_on_merge_queue_plan')) &&
      !contains(github.event.pull_request.labels.*.name, 'skip_ci_on_merge_queue_plan')
    runs-on: ubuntu-latest
    steps:
      - name: Show PR Info
        run: |
          echo "PR branch: ${{ github.head_ref }}"
          echo "Target branch: ${{ github.base_ref }}"
          echo "Labels: ${{ toJson(github.event.pull_request.labels) }}"

  upgrade_extended_test:
    needs: [optimize_ci, run_condition_check]
    if: needs.optimize_ci.outputs.skip == 'false' && needs.run_condition_check.result == 'success'
    env:
      GOPRIVATE: github.com/weka
    name: upgrade_extended_test
    outputs:
      operator_image: ${{ steps.set-operator-versions.outputs.operator_image }}
      operator_helm_image: ${{ steps.set-operator-versions.outputs.operator_helm_image }}
    runs-on: scalar-runners
    steps:
      - name: Check Docker
        run: |
          docker version
          docker info

      - uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.SCALAR_WORKERS_APP_ID }}
          private-key: ${{ secrets.SCALAR_WORKERS_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
 
      - name: Checkout operator repository
        uses: actions/checkout@v4
        with:
          path: operator
          submodules: true
          token: ${{ steps.app-token.outputs.token }}

      - name: Checkout wekai repository
        uses: actions/checkout@v4
        with:
          repository: weka/wekai
          token: ${{ steps.app-token.outputs.token }}
          path: wekai

      - name: Checkout testing repository
        uses: actions/checkout@v4
        with:
          repository: weka/weka-k8s-testing
          token: ${{ steps.app-token.outputs.token }}
          path: testing
          submodules: true

      - name: Save Kubeconfig(s)
        run: |
          mkdir -p ${{ github.workspace }}/.kube
          echo "${{ secrets.UPGRADE_TEST_KUBECONFIG }}" > ${{ github.workspace }}/.kube/config
          chmod 600 ${{ github.workspace }}/.kube/config

      - name: Call Generate Test Artifacts
        uses: dagger/dagger-for-github@8.0.0
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        with:
          version: "latest"
          workdir: operator/.dagger/src
          module: operator_flows
          args: >-
            generate-pr-test-artifacts
            --operator=${{ github.workspace }}/operator
            --pr-number=${{ github.event.pull_request.number }}
            --gh-token="env://GH_TOKEN"
            --openai-api-key="env://OPENAI_API_KEY"
            export --path ${{ github.workspace }}/test-artifacts

      - name: Upload test artifacts (AI-generated test plan)
        uses: actions/upload-artifact@v4
        with:
          name: ai-generated-test-plan
          if-no-files-found: ignore
          path: ${{ github.workspace }}/test-artifacts
          retention-days: 1

      - name: Publish Operator
        uses: dagger/dagger-for-github@8.0.0
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        with:
          version: "latest"
          workdir: operator/.dagger/src
          module: operator_flows
          args: >-
            publish-operator-and-get-versions 
            --operator=${{ github.workspace }}/operator
            --gh-token="env://GH_TOKEN"
            --sock=/var/run/docker.sock
            --output ${{ github.workspace }}/versions
      
      - name: Set Operator Versions (to output and environment variables)
        id: set-operator-versions
        run: |
          echo "Setting operator versions as environment variables"
          versions=$(cat ${{ github.workspace }}/versions)
          operator_image=$(echo "$versions" | head -n 1)
          operator_helm_image=$(echo "$versions" | tail -n 1)

          echo "Operator Image: $operator_image"
          echo "Operator Helm Image: $operator_helm_image"
          
          echo "operator_image=$operator_image" >> $GITHUB_ENV
          echo "operator_helm_image=$operator_helm_image" >> $GITHUB_ENV

          echo "operator_image=$operator_image" >> $GITHUB_OUTPUT
          echo "operator_helm_image=$operator_helm_image" >> $GITHUB_OUTPUT

      - name: Debug test artifacts directory
        run: |
          echo "Checking test-artifacts directory:"
          ls -la ${{ github.workspace }}/test-artifacts || echo "Directory not found"
          find ${{ github.workspace }}/test-artifacts -type f -name "*.sh" -exec ls -la {} \; || echo "No .sh files found"

      - name: Run Upgrade-extended Test
        uses: dagger/dagger-for-github@8.0.0
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        with:
          version: "latest"
          workdir: operator/.dagger/src
          module: operator_flows
          args: >-
            run-upgrade-extended-test
            --operator=${{ github.workspace }}/operator
            --testing=${{ github.workspace }}/testing
            --wekai=${{ github.workspace }}/wekai
            --sock=/var/run/docker.sock
            --pr-number=${{ github.event.pull_request.number }}
            --gh-token="env://GH_TOKEN"
            --gh-sha=${{ github.sha }}
            --execution-id=GHA-${{ github.run_id }}
            --execution-temp-dir=/testing_shared/executions/GHA-${{ github.run_id }}
            --openai-api-key="env://OPENAI_API_KEY"
            --gemini-api-key="env://GEMINI_API_KEY"
            --kubeconfig-path=file://${{ github.workspace }}/.kube/config
            --initial-weka-version=${{ env.INITIAL_WEKA_VERSION }}
            --new-weka-version=${{ env.NEW_WEKA_VERSION }}
            --test-artifacts-dir=${{ github.workspace }}/test-artifacts
            --use-gh-token-for-go-deps
            --operator-image=${{ env.operator_image }}
            --operator-helm-image=${{ env.operator_helm_image }}
            --embedded-csi

      - name: Upload Wekai execution files
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: wekai-execution-files
          if-no-files-found: ignore
          path: /testing_shared/executions/GHA-${{ github.run_id }}
          retention-days: 1
  
  clients_only_test:
    needs: [optimize_ci, run_condition_check, upgrade_extended_test]
    if: needs.run_condition_check.result == 'success' && needs.upgrade_extended_test.result == 'success'
    runs-on: scalar-runners
    steps:
      - uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.SCALAR_WORKERS_APP_ID }}
          private-key: ${{ secrets.SCALAR_WORKERS_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Checkout operator repository
        uses: actions/checkout@v4
        with:
          path: operator
          token: ${{ steps.app-token.outputs.token }}

      - name: Checkout testing repository
        uses: actions/checkout@v4
        with:
          repository: weka/weka-k8s-testing
          token: ${{ steps.app-token.outputs.token }}
          path: testing
          submodules: true

      - name: Save Kubeconfig(s)
        run: |
          mkdir -p ${{ github.workspace }}/.kube
          echo "${{ secrets.UPGRADE_TEST_KUBECONFIG }}" > ${{ github.workspace }}/.kube/config
          echo "${{ secrets.OCP_CLUSTER_KUBECONFIG }}" > ${{ github.workspace }}/.kube/ocp-cluster-config
          chmod 600 ${{ github.workspace }}/.kube/config
          chmod 600 ${{ github.workspace }}/.kube/ocp-cluster-config

      - name: Run OCP Clients-Only Test
        uses: dagger/dagger-for-github@8.0.0
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        with:
          version: "latest"
          workdir: operator/.dagger/src
          module: operator_flows
          args: >-
            run-ocp-clients-only-test
            --sock=/var/run/docker.sock
            --gh-token="env://GH_TOKEN"
            --testing=${{ github.workspace }}/testing
            --source-kubeconfig=file://${{ github.workspace }}/.kube/config
            --target-kubeconfig=file://${{ github.workspace }}/.kube/ocp-cluster-config
            --use-gh-token-for-go-deps
            --operator-image=${{ needs.upgrade_extended_test.outputs.operator_image }}
            --operator-helm-image=${{ needs.upgrade_extended_test.outputs.operator_helm_image }}

  ci_on_merge_queue_required_status:
    needs: [run_condition_check, upgrade_extended_test, clients_only_test]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Validate required workflow
        run: |
          if [[ "${{ needs.run_condition_check.result }}" == "success" ]]; then
            [[ "${{ needs.upgrade_extended_test.result }}" == "success" && "${{ needs.clients_only_test.result }}" == "success" ]] || exit 1
          fi
