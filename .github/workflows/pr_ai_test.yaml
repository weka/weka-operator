name: Run Test with AI hooks
run-name: ${{ github.actor }} is running the AI test

# make sure only one workflow is running at a time
concurrency:
  group: upgrade-test
  cancel-in-progress: false

permissions:
  contents: read
  pull-requests: read
  actions: read

on:
  pull_request:
    types:
      - ready_for_review
    # branches:
    #   - main

jobs:
  optimize_ci:
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.check_skip.outputs.skip }}
    steps:
    - name: Optimize CI
      id: check_skip
      uses: withgraphite/graphite-ci-action@main
      with:
        graphite_token: ${{ secrets.GRAPHITE_TOKEN }}
        
  get_pr_info:
    runs-on: ubuntu-latest
    needs: optimize_ci
    if: needs.optimize_ci.outputs.skip == 'false'
    outputs:
      pr_description: ${{ steps.get_pr_description.outputs.description }}
      pr_diff: ${{ steps.get_pr_diff.outputs.diff }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
          
      - name: Get PR description
        id: get_pr_description
        uses: actions/github-script@v6
        with:
          script: |
            const { data: pullRequest } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const description = pullRequest.body || '';
            console.log(`PR Description: ${description}`);
            return core.setOutput('description', description);
            
      - name: Get PR diff
        id: get_pr_diff
        uses: actions/github-script@v6
        with:
          script: |
            const { data: diff } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              mediaType: {
                format: 'diff'
              }
            });
            
            // Define max size for raw diff to prevent huge diffs in prompts
            const MAX_DIFF_SIZE = 10 * 1024; // 10 KB limit for raw diff
            
            let diffContent;
            let diffSummary;
            
            if (typeof diff === 'string' && diff.length > MAX_DIFF_SIZE) {
              // Get the number of changed files from the diff
              const changedFilesCount = (diff.match(/^diff --git/gm) || []).length;
              
              // Extract file names that were changed
              const fileRegex = /^diff --git a\/(.*?) b\/(.*?)$/gm;
              let match;
              const changedFiles = [];
              while ((match = fileRegex.exec(diff)) !== null) {
                changedFiles.push(match[2]);
                if (changedFiles.length >= 20) break; // Limit to first 20 files
              }
              
              // Get some stats on lines changed
              const additionLines = (diff.match(/^\+[^+]/gm) || []).length;
              const deletionLines = (diff.match(/^-[^-]/gm) || []).length;
              
              // Create a summary instead of using the full diff
              diffSummary = {
                changedFilesCount,
                changedFiles: changedFiles.slice(0, 20),
                moreFiles: changedFiles.length >= 20,
                additionLines,
                deletionLines,
                truncated: true,
                diffPreview: diff.substring(0, 1000) + "..." // Short preview of the beginning
              };
              
              diffContent = JSON.stringify(diffSummary);
              console.log(`PR Diff was too large (${diff.length} bytes), created summary instead.`);
            } else {
              diffContent = JSON.stringify(diff);
              console.log(`PR Diff retrieved: ${diffContent.substring(0, 100)}...`);
            }
            
            return core.setOutput('diff', diffContent);

      - name: Display PR info
        run: |
          echo "PR Description: ${{ steps.get_pr_description.outputs.description }}"

  get_wekai_app:
    runs-on: ubuntu-latest
    needs: optimize_ci
    if: needs.optimize_ci.outputs.skip == 'false'
    env:
      GOPRIVATE: github.com/weka
    steps:
      - name: Check out wekai private repo
        uses: actions/checkout@v4
        with:
          repository: weka/wekai
          ssh-key: ${{ secrets.WEKAI_DEPLOY_SSH_KEY }}
      - name: Set up SSH  # See: https://github.com/webfactory/ssh-agent?tab=readme-ov-file#support-for-github-deploy-keys
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: |
            ${{ secrets.GO_WEKA_OBSERVABILITY_DEPLOY_SSH_KEY }}
      - name: Setup access for private go modules
        run: |
          git config --global url."ssh://git@github.com/".insteadOf https://github.com/
      - uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
      - name: Build Go Binary
        run: |
          go build -o wekai main.go
      - name: Upload Binary Artifact
        uses: actions/upload-artifact@v4
        with:
          name: wekai
          path: ./wekai
          overwrite: true
          retention-days: 1

  get_test_hooks_description:
    runs-on: ubuntu-latest
    needs: optimize_ci
    if: needs.optimize_ci.outputs.skip == 'false'
    env:
      GOPRIVATE: github.com/weka
    outputs:
      test_description: ${{ steps.save_upgrade_test_description.outputs.test_description }}
      test_hooks_description: ${{ steps.save_hooks_description.outputs.hooks_description }}
      hooks_env_vars: ${{ steps.save_hook_env_vars_description.outputs.hooks_env_vars }}
    steps:
      - name: Check out wekai private repo
        uses: actions/checkout@v4
        with:
          repository: weka/weka-k8s-testing
          ssh-key: ${{ secrets.WEKA_K8S_TESTING_DEPLOY_SSH_KEY }}
      - name: Save upgrade test description
        id: save_upgrade_test_description
        run: |
          echo "Saving upgrade test description"
          echo "test_description<<EOF" >> $GITHUB_OUTPUT
          cat doc/upgrade_extended/test_description.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      - name: Save upgrade test hooks description to output
        id: save_hooks_description
        run: |
          echo "Saving upgrade test hooks description"
          echo "hooks_description<<EOF" >> $GITHUB_OUTPUT
          cat doc/upgrade_extended/hooks.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      - name: Save hook env vars description
        id: save_hook_env_vars_description
        run: |
          echo "Saving hook env vars description"
          echo "hooks_env_vars<<EOF" >> $GITHUB_OUTPUT
          cat doc/upgrade_extended/hooks_environmnent_variables.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  can_test_using_hooks:
    runs-on: ubuntu-latest
    needs: [get_pr_info, get_wekai_app, get_test_hooks_description]
    # outputs:
      # can_use_hooks: ${{ steps.analyze_wekai_response.outputs.can_use_hooks }}
    steps:
      - name: Checkout operator
        uses: actions/checkout@v4
      - name: Download wekai binary
        uses: actions/download-artifact@v4
        with:
          name: wekai
      - name: Make binary executable
        run: chmod +x ./wekai
      - name: Generate diff section
        id: generate_diff_section
        run: |
          echo "Generating diff section based on PR diff"
          
          # Extract and parse the diff content
          DIFF_CONTENT='${{ needs.get_pr_info.outputs.pr_diff }}'
          
          # Generate the diff section based on whether it's truncated or not
          DIFF_SECTION=$(cat << 'EOF'
          ### PR Diff
          EOF
          )
          
          # Check if the diff is a JSON object with a truncated property
          if echo "$DIFF_CONTENT" | grep -q '"truncated":true'; then
            # Extract properties from the JSON diff summary
            FILES_COUNT=$(echo "$DIFF_CONTENT" | jq -r '.changedFilesCount')
            CHANGED_FILES=$(echo "$DIFF_CONTENT" | jq -r '.changedFiles | join("\n- ")')
            MORE_FILES=$(echo "$DIFF_CONTENT" | jq -r '.moreFiles')
            ADDITIONS=$(echo "$DIFF_CONTENT" | jq -r '.additionLines')
            DELETIONS=$(echo "$DIFF_CONTENT" | jq -r '.deletionLines')
            DIFF_PREVIEW=$(echo "$DIFF_CONTENT" | jq -r '.diffPreview')
            
            # Create a human-readable summary
            DIFF_SECTION=$(cat << EOF
          ### PR Diff (Summary)
          This diff was too large to include in full. Here is a summary:
          
          **Files changed:** $FILES_COUNT total files
          **Lines changed:** +$ADDITIONS, -$DELETIONS
          
          **Changed files (showing first 20):**
          - $CHANGED_FILES
          $([ "$MORE_FILES" == "true" ] && echo "- ... and more files not shown")
          
          **Preview of the beginning of the diff:**
          \`\`\`diff
          $DIFF_PREVIEW
          \`\`\`
          EOF
            )
          else
            # Use the original diff content
            DIFF_SECTION=$(cat << EOF
          ### PR Diff
          \`\`\`diff
          $DIFF_CONTENT
          \`\`\`
          EOF
            )
          fi
          
          # Save diff section to output
          {
            echo "diff_section<<EOF"
            echo "$DIFF_SECTION"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Save files for AI prompt
        id: save_files_for_ai
        run: |
          cat aitests/github_actions/pr_ai_test/base_instructions.txt > base_instructions.txt
          cat aitests/github_actions/pr_ai_test/hooks_guidance.txt > hooks_guidance.txt
          cat <<'EOF' > upgrade_test_description.txt
          ${{ needs.get_test_hooks_description.outputs.test_description }}
          EOF
          cat <<'EOF' > hooks_description.txt
          ${{ needs.get_test_hooks_description.outputs.test_hooks_description }}
          EOF
          cat <<'EOF' > hooks_env_vars.txt
          ${{ needs.get_test_hooks_description.outputs.hooks_env_vars }}
          EOF
          cat <<'EOF' > pr_description.txt
          ${{ needs.get_pr_info.outputs.pr_description }}
          EOF
          cat <<'EOF' > pr_diff.txt
          ${{ steps.generate_diff_section.outputs.diff_section }}
          EOF

      - name: Set up Python and install uv
        run: |
          python -m pip install --upgrade pip
          pip install uv
          
      - name: Run generate_hooks scripts (determine if can test using hooks)
        id: run_generate_hooks
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          ./script/generate_hooks.py \
            --docs-dir="$(pwd)/doc/" \
            --base-instructions-path="base_instructions.txt" \
            --upgrade-test-description-path="upgrade_test_description.txt" \
            --upgrade-test-hooks-description-path="hooks_description.txt" \
            --upgrade-test-hooks-env-vars-path="hooks_env_vars.txt" \
            --hooks-guidance-path="hooks_guidance.txt" \
            --pr-description-path="pr_description.txt" \
            --pr-diff-path="pr_diff.txt"

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts
          path: test_artifacts/
          retention-days: 1
