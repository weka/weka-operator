# NOTE: This workflow is for WEKA internal CI/CD and requires access to internal infrastructure.
# External contributors: Your PRs will be tested by WEKA maintainers using internal CI.
name: Run Upgrade Test
run-name: ${{ github.actor }} is running the upgrade test

# make sure only one workflow is running at a time
concurrency:
  group: upgrade-test
  cancel-in-progress: false

permissions:
  contents: read
  pull-requests: read
  actions: read

on:
  # workflow_run:
  #   workflows:
  #     - Package Operator (HELM)
  #   types:
  #     - completed
  workflow_dispatch:
    inputs:
      operator-version:
        description: 'Name of the existing operator version'
        required: true
      weka-initial-version:
        description: 'Initial Weka version'
        required: true
        default: quay.io/weka.io/weka-in-container:4.4.5.118-k8s.3
      weka-new-version:
        description: 'New Weka version'
        required: true
        default: quay.io/weka.io/weka-in-container:4.4.10.183
      do_cleanup:
        description: 'Whether to clean up the cluster after the test'
        required: false
        default: 'true'

jobs:
  optimize_ci:
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.check_skip.outputs.skip }}
    steps:
    - name: Optimize CI
      id: check_skip
      uses: withgraphite/graphite-ci-action@v0.0.9
      with:
        graphite_token: ${{ secrets.GRAPHITE_TOKEN }}

  get_operator_version:
    runs-on: ubuntu-latest
    needs: optimize_ci
    if: needs.optimize_ci.outputs.skip == 'false' && (github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success'))
    outputs:
      should_run: ${{ steps.check_artifact.outputs.should_run }}
      operator_version: ${{ steps.check_artifact.outputs.operator_version }}
    steps:
      - name: Download operator version artifact
        uses: actions/download-artifact@v4
        if: github.event_name == 'workflow_run'
        with:
          name: operator-version
          repository: ${{ github.event.workflow_run.repository.full_name }}
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
      - name: Check if operator version is empty
        id: check_artifact
        if: github.event_name == 'workflow_run'
        run: |
          if [ ! -f operator-version.txt ] || [ ! -s operator-version.txt ]; then
            echo "Operator version is empty. Stopping the workflow."
            echo "should_run=false" >> "$GITHUB_OUTPUT"
          else
            OPERATOR_VERSION=v$(cat operator-version.txt)
            echo "Operator version: ${OPERATOR_VERSION}"

            echo "operator_version=${OPERATOR_VERSION}" >> "$GITHUB_OUTPUT"
            echo "should_run=true" >> "$GITHUB_OUTPUT"
          fi

  build:
    runs-on: ubuntu-latest
    needs: get_operator_version
    if: needs.get_operator_version.outputs.should_run == 'true' || github.event_name == 'workflow_dispatch'
    env:
      GOPRIVATE: github.com/weka
    steps:
      - uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.SCALAR_WORKERS_APP_ID }}
          private-key: ${{ secrets.SCALAR_WORKERS_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Setup access for private go modules
        run: |
          git config --global url."https://x-access-token:${{ steps.app-token.outputs.token }}@github.com/".insteadOf https://github.com/
          git config --global url."https://x-access-token:${{ steps.app-token.outputs.token }}@github.com/".insteadOf git@github.com:
          echo "machine github.com login x-access-token password ${{ steps.app-token.outputs.token }}" > ~/.netrc
          chmod 600 ~/.netrc

      - name: Check out weka-k8s-testing private repo
        uses: actions/checkout@v4
        with:
          repository: weka/weka-k8s-testing
          token: ${{ steps.app-token.outputs.token }}
          submodules: recursive

      - uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true
      - name: Build Go Binary
        run: |
          go build -o weka-k8s-testing main.go
      - name: Upload Binary Artifact
        uses: actions/upload-artifact@v4
        with:
          name: weka-k8s-testing-binary
          path: ./weka-k8s-testing
          overwrite: true
          retention-days: 1

  upgrade_test:
    needs: [get_operator_version, build]
    runs-on: scalar-runners
    env:
      OPERATOR_VERSION: ${{ needs.get_operator_version.outputs.operator_version }}
    steps:
    - name: Check out current repo
      uses: actions/checkout@v4

    - uses: azure/k8s-set-context@v4
      name: Set K8s context
      with:
        method: kubeconfig
        kubeconfig: ${{ secrets.UPGRADE_TEST_KUBECONFIG }}

    - name: Download Weka K8s Testing Binary
      uses: actions/download-artifact@v4
      with:
        name: weka-k8s-testing-binary
    - name: Make binary executable
      run: chmod +x ./weka-k8s-testing
    - name: Run upgrade test
      run: |
        cleanup=""
        if [[ "${{ github.event.inputs.do_cleanup }}" == "false" ]]; then
          cleanup="--cleanup no-cleanup"
        fi

        ./weka-k8s-testing upgrade-extended \
          --initial-version ${{ github.event.inputs.weka-initial-version || 'quay.io/weka.io/weka-in-container:4.4.5.118-k8s.' }} \
          --new-version ${{ github.event.inputs.weka-new-version || 'quay.io/weka.io/weka-in-container:4.4.10.183' }} \
          --operator-version ${{ env.OPERATOR_VERSION || github.event.inputs.operator-version }} \
          --node-selector weka.io/dedicated:upgrade-extended \
          --namespace test-upgrade-extended \
          --cluster-name upgrade-extended \
          $cleanup
